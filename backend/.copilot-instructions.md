# GitHub Copilot Instructions - SmartDocRAG

## Visão Geral do Projeto

Este é um sistema RAG (Retrieval-Augmented Generation) em TypeScript/Node.js que permite:

- Upload e processamento de documentos
- Geração de embeddings vetoriais usando OpenAI
- Consultas inteligentes com busca por similaridade vetorial
- Respostas contextualizadas usando GPT-4o-mini

## Arquitetura e Padrões

### Stack Tecnológico

- **Backend**: Node.js + Express + TypeScript
- **Banco de Dados**: PostgreSQL com suporte a vetores (pgvector)
- **IA**: OpenAI API (embeddings e chat completion)
- **Upload**: Multer para processamento de arquivos

### Estrutura de Pastas

```
src/
├── index.ts              # Servidor Express principal
routes/                   # Endpoints da API REST
├── upload.ts            # POST /upload - Upload de arquivos
├── ingest.ts            # POST /ingest - Processamento e ingestão
└── query.ts             # POST /query - Consultas RAG
services/                # Camada de serviços
├── dbService.ts         # Pool de conexão PostgreSQL
├── embeddingService.ts  # Geração de embeddings OpenAI
└── chunckService.ts     # Divisão de texto em chunks
utils/
└── logger.ts            # Utilitários de logging
```

## Padrões de Código

### 1. Estrutura de Rotas

- Use Express Router para cada endpoint
- Sempre validar parâmetros de entrada
- Retornar status codes apropriados (400 para bad request, 500 para server error)
- Usar try-catch para tratamento de erros
- Log de erros no console

### 2. Serviços de Banco de Dados

- Use o pool de conexão PostgreSQL exportado de `dbService.ts`
- Queries parametrizadas para evitar SQL injection
- Exemplo de query com vetores: `SELECT content, embedding <-> $1 AS distance`

### 3. Integração OpenAI

- Use a instância configurada do cliente OpenAI
- Modelo para embeddings: `text-embedding-3-small`
- Modelo para chat: `gpt-4o-mini`
- Sempre verificar se a resposta contém dados válidos

### 4. Processamento de Texto

- Chunks devem ter no máximo 500 caracteres
- Divisão por sentenças (usando regex para pontuação)
- Preservar contexto semântico nos chunks

## Exemplos de Código

### Estrutura de Rota Típica

```typescript
import express from "express";
import { pool } from "../services/dbService";

const router = express.Router();

router.post("/", async (req, res) => {
  try {
    const { param1, param2 } = req.body;

    if (!param1 || !param2) {
      return res.status(400).json({ error: "Missing required parameters" });
    }

    // Lógica do endpoint

    res.status(200).json({ message: "Success" });
  } catch (error) {
    console.error("Error in route:", error);
    res.status(500).json({ error: "Internal server error" });
  }
});

export default router;
```

### Query com Vetores

```typescript
const results = await pool.query(
  "SELECT content, embedding <-> $1 AS distance FROM chunks ORDER BY distance ASC LIMIT 5",
  [vector]
);
```

### Geração de Embedding

```typescript
const embeddingRes = await openai.embeddings.create({
  model: "text-embedding-3-small",
  input: text,
});
const vector = embeddingRes?.data[0]?.embedding;
```

## Convenções

### Nomenclatura

- Variáveis e funções: camelCase
- Constantes: UPPER_SNAKE_CASE
- Arquivos: camelCase ou kebab-case
- Rotas: lowercase com hífen se necessário

### Tratamento de Erros

- Sempre usar try-catch em funções async
- Log detalhado de erros no console
- Retornar mensagens de erro padronizadas para o cliente
- Status codes apropriados (400, 500, etc.)

### Validação de Dados

- Verificar parâmetros obrigatórios no início das rotas
- Validar tipos de dados quando necessário
- Retornar erro 400 para dados inválidos

## Banco de Dados

### Tabelas Principais

```sql
-- Documentos
documents (
    id SERIAL PRIMARY KEY,
    name VARCHAR NOT NULL
)

-- Chunks com embeddings
chunks (
    id SERIAL PRIMARY KEY,
    document_id INTEGER REFERENCES documents(id),
    content TEXT NOT NULL,
    embedding vector(1536) -- OpenAI embedding size
)
```

### Operações Comuns

- Inserção com RETURNING para obter ID gerado
- Busca por similaridade usando operador `<->`
- Joins entre documents e chunks quando necessário

## Variáveis de Ambiente

```
OPENAI_API_KEY=your_openai_api_key
DATABASE_URL=postgresql://user:password@localhost:5432/dbname
PORT=3000
```

## Notas Importantes

- O projeto usa CommonJS (`"type": "commonjs"` no package.json)
- Há alguns typos intencionais preservados (ex: "chunck" ao invés de "chunk")
- Upload de arquivos vai para pasta `uploads/`
- Embeddings são vetores de 1536 dimensões (modelo text-embedding-3-small)
- Limite de tokens para chunks: aproximadamente 500 caracteres

## Quando Sugerir Melhorias

- Adicionar validação mais robusta
- Implementar logging estruturado
- Adicionar testes unitários
- Implementar cache para embeddings
- Adicionar retry logic para APIs externas
- Implementar paginação para queries grandes
